<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Add Screen | mStore Demo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f2f5;
            --bg-tertiary: #e4e6eb;
            --text-primary: #1c1e21;
            --text-secondary: #65676b;
            --accent-primary: #4361ee;
            --accent-primary-rgb: 67, 97, 238;
            --accent-primary-hover: #3a52c4;
            --accent-success: #28a745;
            --accent-danger: #dc3545;
            --border-color: #dddfe2;
            --top-nav-height: 60px;
            --bottom-nav-height: 65px;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .dark-mode {
            --bg-primary: #18191a;
            --bg-secondary: #242526;
            --bg-tertiary: #3a3b3c;
            --text-primary: #e4e6eb;
            --text-secondary: #b0b3b8;
            --accent-success: #20c997;
            --accent-danger: #ff6b6b;
            --border-color: #3a3b3c;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.2);
            --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.25);
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            margin: 0;
            padding: 0;
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
            overflow: hidden; /* Prevent body scroll */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Fake Navigations --- */
        .top-nav {
            height: var(--top-nav-height);
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
        }

        .top-nav.no-shadow {
            box-shadow: none;
        }

        .top-nav-title {
            font-weight: 600;
            font-size: 18px;
        }

        .bottom-nav {
            height: var(--bottom-nav-height);
            background: var(--bg-primary);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            z-index: 100;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-secondary);
            font-size: 11px;
            font-weight: 500;
            flex: 1;
        }

        .bottom-nav-item i {
            font-size: 22px;
            margin-bottom: 5px;
        }

        .bottom-nav-item.active {
            color: var(--accent-primary);
        }

        .bottom-nav-item.add-button {
            transform: translateY(-15px);
        }

        .bottom-nav-item.add-button .add-icon-wrapper {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--accent-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(var(--accent-primary-rgb), 0.4);
            margin-bottom: 5px;
        }

        .bottom-nav-item.add-button i {
            font-size: 24px;
        }

        /* --- Main Content Wrapper --- */
        .add-screen-view {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- Horizontal Tabs --- */
        .add-primary-tabs {
            display: flex;
            overflow-x: auto;
            padding: 8px 16px 0;
            gap: 12px;
            flex-shrink: 0;
            position: relative;
            border-bottom: 1px solid var(--border-color);
            scrollbar-width: none; /* Firefox */
            background-color: var(--bg-primary);
        }
        .add-primary-tabs::-webkit-scrollbar { display: none; }

        .tab-btn {
            padding: 10px 4px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            white-space: nowrap;
            position: relative;
            transition: color 0.2s ease;
        }

        .tab-btn.active {
            color: var(--text-primary);
        }

        .tab-indicator {
            position: absolute;
            bottom: 0;
            height: 3px;
            background-color: var(--accent-primary);
            border-radius: 1.5px;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- Main Content --- */
        .add-screen-content {
            flex-grow: 1;
            display: flex;
            overflow: hidden; /* Hide non-active panes */
            position: relative;
            background-color: var(--bg-secondary);
        }

        /* --- Scrollable Content --- */
        .add-scrollable-content {
            min-width: 100%;
            height: 100%;
            overflow-y: hidden;
            box-sizing: border-box;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        /* NEW: This is the new scrollable container inside each pane */
        .content-scrollable-area {
            flex-grow: 1;
            overflow-y: auto;
        }
        /* --- NEW: Transaction Card Specific Styles --- */
        .transaction-card {
            background-color: var(--bg-primary);
            border-radius: 10px;
            box-shadow: var(--shadow-light); /* FIX: Changed padding to be consistent and reduced horizontal padding */
            padding: 5px 10px 10px 10px;
            display: flex;
            flex-direction: column;
            gap: 1px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .transaction-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .transaction-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        
        }

        .party-name {
            font-weight: 500;
            font-size: 15px;
            color: var(--text-primary);
        }

        .transaction-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
        }

        .transaction-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 2px 0px;
            border-radius: 12px;
            text-transform: uppercase;
        }

        .transaction-badge.sale {
            background-color: rgba(var(--accent-success), 0.15);
            color: var(--accent-success);
        }

        .transaction-badge.purchase {
            background-color: rgba(var(--accent-danger), 0.15);
            color: var(--accent-danger);
        }

        .bill-no {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .transaction-datetime {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .transaction-financials {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .transaction-financials .amount {
            font-weight: 600;
        }

        .transaction-financials .amount.success {
            color: var(--accent-success);
        }

        .transaction-financials .amount.danger {
            color: var(--accent-danger);
        }

        .transaction-financials .amount.due {
            color: var(--accent-warning, #ffc107);
        }

        .transaction-financials .text-right {
            text-align: right;
        }
        .transaction-actions { 
            display: flex; 
            gap: 2px; 
            margin-right: -13px;
        }
        .action-icon-btn { 
            background: none;
             border: none; 
             color: var(--text-secondary);
             width: 32px;
             height: 32px;
             border-radius: 50%;
             cursor: pointer; 
             display: grid; 
             place-items: center; 
             transition: background-color 0.2s ease;
        }
        .action-icon-btn:hover {
            background-color: var(--bg-secondary); 
        }

        .content-card {
            background-color: var(--bg-primary);
            border-radius: 10px;
            box-shadow: var(--shadow-light);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .content-card-icon {
            width: 40px;
            height: 40px;
            flex-shrink: 0;
            display: grid;
            place-items: center;
            border-radius: 50%;
            font-size: 20px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
        }

        .content-card-details {
            flex-grow: 1;
        }
        .content-card-title { font-weight: 600; font-size: 15px; }
        .content-card-subtitle { font-size: 12px; color: var(--text-secondary); }

        /* REFACTORED: Party card details now use a column layout */
        .content-card-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden; /* Prevents long names from breaking layout */
        }
        .party-details-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .content-card-amount {
            font-weight: 600;
            font-size: 15px;
        }
        .content-card-amount.success { color: var(--accent-success); }
        .content-card-amount.danger { color: var(--accent-danger); }

        /* NEW: Style for party balance amount */
        .party-balance-amount {
            font-weight: 600;
            font-size: 15px;
            flex-shrink: 0; /* Prevent amount from shrinking */
            text-align: right;
        }
        .party-balance-label {
            font-size: 12px;
            font-weight: 500;
            text-align: right;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .inventory-item-thumb {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .inventory-stock {
            text-align: right;
        }
        .inventory-stock .stock-qty { font-weight: 600; font-size: 16px; }
        /* New class for low stock indication */
        .inventory-stock .stock-qty.low-stock {
            color: var(--accent-danger);
        }
        .inventory-stock .stock-label { font-size: 12px; color: var(--text-secondary); }

        .post-card-small {
            display: flex;
            gap: 12px;
            padding: 12px;
            background-color: var(--bg-primary);
            border-radius: 10px;
            box-shadow: var(--shadow-light);
        }
        .post-card-small img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }
        .post-card-small-content .text {
            font-size: 14px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .post-card-small-content .stats {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .placeholder-content {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .placeholder-content i {
            font-size: 40px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* --- NEW: Filter Bar Styles --- */
        .content-filter-bar {
            display: flex;
            gap: 8px;
            padding: 4px 12px 2px 12px;
            margin: 0; /* Margin is no longer needed */
            overflow-x: auto;
            scrollbar-width: none;
            clip-path: inset(0 0 0 0);
            flex-shrink: 0; 
            z-index: 5; 
        }
        .content-filter-bar::-webkit-scrollbar { display: none; }
        .filter-btn {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 5px 15px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
        }
        .filter-btn.active { background-color: var(--accent-primary); color: white; border-color: var(--accent-primary); }
        /* New style for icon inside filter button */
        .filter-btn i {
            margin-right: 4px; /* Reduced margin */
        }

        /* NEW: Styles for filter-helper-only filter button */
        .filter-btn.filter-helper-only {
            padding: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0; /* Prevent icon button from shrinking */
        }
        .filter-btn.filter-helper-only i {
            margin-right: 0; /* No margin for centered icon */
        }

        /* NEW: Container for the actual list of items (transactions, inventory, etc.) */
        .list-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 0 12px 12px; /* Add padding to sides and bottom */
        }

        /* --- Floating Action Button (FAB) & Speed Dial --- */
        .fab-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 90;
        }

        .fab-main {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--accent-primary);
            color: white;
            border: none;
            display: grid;
            place-items: center;
            font-size: 24px;
            box-shadow: var(--shadow-medium);
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fab-main.open {
            transform: rotate(45deg);
        }

        .fab-options {
            position: absolute;
            bottom: 60px; /* Position above the main FAB */
            right: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 16px;
            pointer-events: none; /* Initially not interactive */
        }

        .fab-option-item {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .fab-container.open .fab-options {
            pointer-events: auto; /* Make options interactive when open */
        }

        .fab-container.open .fab-option-item {
            opacity: 1;
            transform: translateY(0);
        }

        /* Staggered animation for options */
        .fab-container.open .fab-option-item:nth-child(1) { transition-delay: 0.1s; }
        .fab-container.open .fab-option-item:nth-child(2) { transition-delay: 0.08s; }
        .fab-container.open .fab-option-item:nth-child(3) { transition-delay: 0.06s; }
        .fab-container.open .fab-option-item:nth-child(4) { transition-delay: 0.04s; }

        .fab-option-label {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: var(--shadow-light);
            white-space: nowrap;
        }

        .fab-option-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            display: grid;
            flex-shrink: 0; /* Prevent the icon from shrinking */
            place-items: center;
            box-shadow: var(--shadow-light);
            font-size: 18px;
        }

        .fab-overlay-btn {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(2px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 80;
        }
        .fab-overlay-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* --- NEW: Date Filter Panel Styles --- */
        .date-filter-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.4);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
            z-index: 1100;
        }
        .date-filter-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .date-filter-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-secondary);
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            box-shadow: var(--shadow-medium);
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1101;
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 16px;
        }
        .date-filter-panel.visible {
            transform: translateY(0);
        }

        .date-filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .date-filter-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        .date-filter-close-btn {
            background: none; border: none; font-size: 20px; color: var(--text-secondary); cursor: pointer;
        }

        .date-filter-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .date-filter-btn {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
        }
        /* NEW: Style for the active (selected) preset button */
        .date-filter-btn.active {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        /* NEW: Styles for the Party Sort/Filter Panel */
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .filter-section h5 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .sort-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .date-filter-custom-range {
            display: flex;
            gap: 10px;
            align-items: center;
            position: relative; /* New: Needed for positioning the input */
        }
        .date-filter-custom-range input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 6px;
            /* NEW: Make the actual input transparent and cover the styled div */
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        /* NEW: A styled div that looks like an input but is just for show */
        .date-input-display {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-secondary); /* Use secondary color for placeholder text */
            border-radius: 6px;
            /* NEW: Use flexbox to align text and icon */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* NEW: Styles for action buttons */
        .date-filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        .date-filter-actions .date-filter-btn {
            flex: 1;
        }
        .date-filter-actions .date-filter-btn.primary {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        .fab-overlay-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="dark-mode">

    <nav class="top-nav no-shadow">
        <div class="top-nav-title">Add View</div>
        <i class="fa-solid fa-xmark" style="cursor: pointer;"></i>
    </nav>

    <div class="add-screen-view">
        <div class="fab-overlay-btn"></div>
        <!-- Horizontal Tabs -->
        <div class="add-primary-tabs">
            <button class="tab-btn active" data-tab="transactions">Transactions</button>
            <button class="tab-btn" data-tab="inventory">Inventory</button>
            <button class="tab-btn" data-tab="parties">Parties</button>
            <button class="tab-btn" data-tab="posts">Posts</button>
            <button class="tab-btn" data-tab="offers">Offers</button>
            <button class="tab-btn" data-tab="banners">Banners</button>
            <div class="tab-indicator"></div>
        </div>

        <!-- NEW: Party Filter Panel HTML -->
        <div class="date-filter-overlay" id="party-filter-overlay"></div>
        <div class="date-filter-panel" id="party-filter-panel">
            <div class="date-filter-header">
                <h4>Sort & Filter Parties</h4>
                <button class="date-filter-close-btn" id="party-filter-close-btn">&times;</button>
            </div>
            <div class="filter-section">
                <h5>Sort By</h5>
                <div class="sort-options">
                    <label><input type="radio" name="party_sort" value="name_asc" checked> Name (A-Z)</label>
                    <label><input type="radio" name="party_sort" value="name_desc"> Name (Z-A)</label>
                    <label><input type="radio" name="party_sort" value="due_desc"> Due Amount (High-Low)</label>
                    <label><input type="radio" name="party_sort" value="due_asc"> Due Amount (Low-High)</label>
                </div>
            </div>
            <div class="date-filter-actions">
                <button class="date-filter-btn secondary" id="party-filter-reset-btn">Reset</button>
                <button class="date-filter-btn primary" id="party-filter-apply-btn">Apply</button>
            </div>
        </div>

        <!-- NEW: Inventory Filter Panel HTML -->
        <div class="date-filter-overlay" id="inventory-filter-overlay"></div>
        <div class="date-filter-panel" id="inventory-filter-panel">
            <div class="date-filter-header">
                <h4>Sort & Filter Inventory</h4>
                <button class="date-filter-close-btn" id="inventory-filter-close-btn">&times;</button>
            </div>
            <div class="filter-section">
                <h5>Sort By</h5>
                <div class="sort-options">
                    <!-- REVISED: Added more sorting options -->
                    <label><input type="radio" name="inventory_sort" value="stock_desc" checked> Stock (High-Low)</label>
                    <label><input type="radio" name="inventory_sort" value="stock_asc"> Stock (Low-High)</label>
                    <label><input type="radio" name="inventory_sort" value="name_asc"> Name (A-Z)</label>
                    <label><input type="radio" name="inventory_sort" value="name_desc"> Name (Z-A)</label>
                    <label><input type="radio" name="inventory_sort" value="price_desc"> Price (High-Low)</label>
                    <label><input type="radio" name="inventory_sort" value="price_asc"> Price (Low-High)</label>
                    <label><input type="radio" name="inventory_sort" value="discount_desc"> Discount (High-Low)</label>
                </div>
            </div>
            <div class="date-filter-actions">
                <button class="date-filter-btn secondary" id="inventory-filter-reset-btn">Reset</button>
                <button class="date-filter-btn primary" id="inventory-filter-apply-btn">Apply</button>
            </div>
        </div>

        <!-- NEW: Date Filter Panel HTML -->
        <div class="date-filter-overlay" id="date-filter-overlay"></div>
        <div class="date-filter-panel" id="date-filter-panel">
            <div class="date-filter-header">
                <h4>Filter by Date</h4>
                <button class="date-filter-close-btn" id="date-filter-close-btn">&times;</button>
            </div>
            <div class="date-filter-options">
                <button class="date-filter-btn" data-range="today">Today</button>
                <button class="date-filter-btn" data-range="yesterday">Yesterday</button>
                <button class="date-filter-btn" data-range="this_week">This Week</button>
                <button class="date-filter-btn" data-range="this_month">This Month</button>
            </div>
            <div class="date-filter-custom-range">
                <div class="date-input-display" id="date-display-start">
                    <span>Start Date</span>
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <input type="date" id="date-filter-start" aria-label="Start Date">
            </div>
            <div class="date-filter-custom-range">
                <div class="date-input-display" id="date-display-end">
                    <span>End Date</span>
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <input type="date" id="date-filter-end" aria-label="End Date">
            </div>
            <div class="date-filter-actions">
                <button class="date-filter-btn secondary" id="date-filter-reset-btn">Reset</button>
                <button class="date-filter-btn primary" id="date-filter-apply-btn">Apply</button>
            </div>
        </div>

        <!-- Content Panes -->
        <div class="add-screen-content">
            <!-- Transactions Pane -->
            <div class="add-scrollable-content" data-tab="transactions">
                <div class="content-filter-bar">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="sale">Sales</button>
                    <button class="filter-btn" data-filter="purchase">Purchases</button>
                    <button class="filter-btn" data-filter="due">Dues</button>
                    <button class="filter-btn filter-helper-only" data-filter="date" title="Filter by Date"><i class="fas fa-calendar-alt"></i></button>
                </div>
                <!-- NEW: Scrollable content area -->
                <div class="content-scrollable-area">
                    <div id="transaction-list-container" class="list-container">
                        <!-- Transaction cards will be dynamically injected here -->
                    </div>
                </div>
            </div>

            <!-- Inventory Pane -->
            <div class="add-scrollable-content" data-tab="inventory">
                <!-- NEW: Inventory Filter Bar -->
                <div class="content-filter-bar">
                    <button class="filter-btn active" data-inventory-filter="all">All</button>
                    <button class="filter-btn" data-inventory-filter="product">Products</button>
                    <button class="filter-btn" data-inventory-filter="service">Services</button>
                    <button class="filter-btn filter-helper-only" data-inventory-filter="advanced" title="Advanced Filters"><i class="fas fa-filter"></i></button>
                </div>
                <div class="content-scrollable-area">
                    <div id="inventory-list-container" class="list-container">
                        <!-- Inventory cards will be dynamically injected here -->
                    </div>
                </div>
            </div>

            <!-- Parties Pane (NEW) -->
            <div class="add-scrollable-content" data-tab="parties">
                <div class="content-filter-bar">
                    <button class="filter-btn active" data-party-filter="all">All</button>
                    <button class="filter-btn" data-party-filter="customer">Customers</button>
                    <button class="filter-btn" data-party-filter="supplier">Suppliers</button>
                    <button class="filter-btn filter-helper-only" data-party-filter="advanced" title="Advanced Filters"><i class="fas fa-filter"></i></button>
                </div>
                <div class="content-scrollable-area">
                    <div id="party-list-container" class="list-container">
                        <!-- Party cards will be dynamically injected here -->
                    </div>
                </div>
            </div>

            <!-- Posts Pane -->
            <div class="add-scrollable-content" data-tab="posts">
                <div class="content-filter-bar">
                    <button class="filter-btn active" data-content-filter="all">All</button>
                    <button class="filter-btn" data-content-filter="posts">Posts</button>
                    <button class="filter-btn" data-content-filter="polls">Polls</button>
                    <button class="filter-btn filter-helper-only" data-content-filter="advanced" title="Advanced Filters"><i class="fas fa-filter"></i></button>
                </div>
                <div class="content-scrollable-area">
                    <div class="list-container">
                        <div class="post-card-small">
                            <img src="https://images.unsplash.com/photo-1555945093-97046180a65e?q=80&w=400&auto=format&fit=crop" alt="Post image">
                            <div class="post-card-small-content">
                                <p class="text">Fresh stock of snacks and cold drinks just arrived! Perfect for your gaming sessions...</p>
                                <div class="stats">95 likes &bull; 12 comments</div>
                            </div>
                        </div>
                        <div class="post-card-small">
                            <div class="post-card-small-content">
                                <p class="text">POLL: What new service should we add to our cafe? Faster Internet or a new Gaming Zone?</p>
                                <div class="stats">180 likes &bull; 35 comments</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Offers Pane -->
            <div class="add-scrollable-content" data-tab="offers">
                <div class="content-filter-bar">
                    <button class="filter-btn active" data-offer-filter="all">All</button>
                    <button class="filter-btn" data-offer-filter="active">Active</button>
                    <button class="filter-btn" data-offer-filter="scheduled">Scheduled</button>
                    <button class="filter-btn" data-offer-filter="expired">Expired</button>
                </div>
                <div class="content-scrollable-area">
                    <div class="content-card">
                        <div class="content-card-icon"><i class="fa-solid fa-tag"></i></div>
                        <div class="content-card-details">
                            <div class="content-card-title">DIWALI20</div>
                            <div class="content-card-subtitle">20% off on all items. Expires in 3 days.</div>
                        </div>
                    </div>
                    <div class="content-card">
                        <div class="content-card-icon"><i class="fa-solid fa-percent"></i></div>
                        <div class="content-card-details">
                            <div class="content-card-title">Weekend Flash Sale</div>
                            <div class="content-card-subtitle">Flat 50% off on electronics.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Banners Pane -->
            <div class="add-scrollable-content" data-tab="banners">
                <div class="content-filter-bar">
                    <button class="filter-btn active" data-banner-filter="all">All</button>
                    <button class="filter-btn" data-banner-filter="active">Active</button>
                    <button class="filter-btn" data-banner-filter="pending">Pending</button>
                    <button class="filter-btn" data-banner-filter="expired">Expired</button>
                </div>
                <div class="content-scrollable-area">
                    <div class="placeholder-content">
                        <i class="fa-solid fa-images"></i>
                        <p>No active banners.<br>Click the '+' button to add a new banner.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Action Button & Speed Dial Menu -->
        <div class="fab-container">
            <div class="fab-options">
                <!-- Options will be injected by JS -->
            </div>
            <button class="fab-main">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>

    </div>

    <nav class="bottom-nav">
        <div class="bottom-nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span> 
        </div>
        <div class="bottom-nav-item">
            <i class="fas fa-comment-dots"></i>
            <span>Chat</span>
        </div>
        <div class="bottom-nav-item">
            <div class="add-icon-wrapper">
                <i class="fa-solid fa-plus"></i>
            </div>
        </div>
        <div class="bottom-nav-item">
            <i class="fa-solid fa-pager"></i>
            <span>Updates</span>
        </div>
        <div class="bottom-nav-item">
            <i class="fas fa-user-circle"></i>
            <span>Account</span>
        </div>
    </nav>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tabsContainer = document.querySelector('.add-primary-tabs');
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabIndicator = document.querySelector('.tab-indicator');
            const contentContainer = document.querySelector('.add-screen-content');
            const contentPanes = document.querySelectorAll('.add-scrollable-content');
            const fabContainer = document.querySelector('.fab-container');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const fabMain = document.querySelector('.fab-main');
            const fabOptionsContainer = document.querySelector('.fab-options');
            const fabOverlay = document.querySelector('.fab-overlay-btn');
            const dateFilterPanel = document.getElementById('date-filter-panel');
            const dateFilterOverlay = document.getElementById('date-filter-overlay');
            const dateFilterCloseBtn = document.getElementById('date-filter-close-btn');

            // --- NEW: Centralized filter state ---
            let currentFilters = {
                primary: 'all', // 'all', 'sale', 'purchase', 'due'
                date: null      // { startDate, endDate, range: 'today'|'yesterday'|... } or null
            };

            // --- NEW: Centralized function to apply all filters and re-render ---
            function applyAllFiltersAndRender() {
                let filtered = [...dummyTransactions];

                // 1. Apply date filter first (if it exists)
                if (currentFilters.date) {
                    const { startDate, endDate } = currentFilters.date;
                    // Set end of day for the end date to include all transactions on that day
                    const endOfDay = new Date(endDate);
                    endOfDay.setHours(23, 59, 59, 999);

                    filtered = filtered.filter(tx => {
                        const txDate = new Date(tx.details.transactionDate);
                        return txDate >= startDate && txDate <= endOfDay;
                    });
                }

                // 2. Apply primary filter (sale, purchase, etc.) on the already date-filtered list
                if (currentFilters.primary !== 'all') {
                    filtered = filtered.filter(tx => tx.meta.type === currentFilters.primary);
                }
                renderTransactions(filtered);
            }


            // --- Speed Dial Actions Data ---
            const fabActions = {
                // REVISED: Actions are now clearer and more logical
                transactions: [
                    { label: 'Payment Out', icon: 'fa-solid fa-money-bill-wave' }, // Money going out
                    { label: 'Payment In', icon: 'fa-solid fa-hand-holding-dollar' }, // Money coming in
                    { label: 'Purchase', icon: 'fa-solid fa-receipt' },
                    { label: 'Sale', icon: 'fa-solid fa-cart-plus' },



                ],
                // REVISED: Reordered inventory actions as per user request
                inventory: [
                    { label: 'Add Bulk Items', icon: 'fa-solid fa-boxes-stacked' },
                    { label: 'Update Stock', icon: 'fa-solid fa-arrow-down-1-9' },
                    { label: 'Add Item', icon: 'fa-solid fa-box-open' }
                ],
                parties: [
                    { label: 'Add Customer', icon: 'fa-solid fa-user-plus' },
                    { label: 'Add Supplier', icon: 'fa-solid fa-user-tie' },
                ],
                posts: [
                    { label: 'Create Post', icon: 'fa-solid fa-pen-to-square' },
                    { label: 'Create Poll', icon: 'fa-solid fa-poll' },
                    { label: 'Add Story', icon: 'fa-solid fa-circle-plus' },
                ],
                offers: [
                    { label: 'Add Offer / Discount', icon: 'fa-solid fa-percent' },
                    { label: 'Schedule Flash Sale', icon: 'fa-solid fa-bolt' },
                    { label: 'Add Coupon', icon: 'fa-solid fa-ticket' },

                ],
                banners: [
                    { label: 'Design From Template', icon: 'fa-solid fa-pen-ruler' },
                    { label: 'Add New Banner', icon: 'fa-solid fa-image' },

                ]
            };

            // --- NEW: Dummy Inventory Data ---
            const dummyInventory = [
                {
                    "meta": { "itemId": "ITM-INV-1", "type": "product" },
                    "info": { "name": "Parle-G Biscuit 80g" },
                    "pricing": { "sellingPrice": 10 },
                    "inventory": { "stockQty": 200, "lowStockThreshold": 20 },
                    "media": { "thumbnail": "./localstore/images/items/parleg-cup.jpg" }
                },
                {
                    "meta": { "itemId": "ITM-INV-2", "type": "product" },
                    "info": { "name": "Tata Salt 1KG" },
                    "pricing": { "sellingPrice": 25 },
                    "inventory": { "stockQty": 100, "lowStockThreshold": 10 },
                    "media": { "thumbnail": "./localstore/images/items/tata-salt.jpg" }
                },
                {
                    "meta": { "itemId": "ITM-INV-3", "type": "product" },
                    "info": { "name": "Surf Excel 500g" },
                    "pricing": { "sellingPrice": 65 },
                    "inventory": { "stockQty": 5, "lowStockThreshold": 10 }, // Low stock example
                    "media": { "thumbnail": "./localstore/images/items/surf-excel.jpg" }
                },
                {
                    "meta": { "itemId": "ITM-INV-4", "type": "service" },
                    "info": { "name": "Photo Print Service" },
                    "pricing": { "sellingPrice": 20 },
                    "inventory": { "stockQty": null }, // Service example
                    "media": { "thumbnail": "./localstore/images/items/photo-print.jpg" }
                }
            ];

            // --- NEW: Dummy Transaction Data & Rendering Logic ---
            const dummyTransactions = [
                {
                    "meta": {
                        "transactionId": "TRN-20251008-110000-123-ABCD",
                        "type": "sale",
                        "status": "partially_paid"
                    },
                    "party": {
                        "name": "Priya Singh"
                    },
                    "details": {
                        "billNumber": "SLE-123",
                        "transactionDate": "2025-10-08T11:00:00Z"
                    },
                    "financials": {
                        "currency": "INR",
                        "totalAmount": 550.00,
                        "paidAmount": 465.00,
                        "due": 85.00
                    }
                },
                {
                    "meta": {
                        "transactionId": "TRN-20251007-054500-456-EFGH",
                        "type": "purchase",
                        "status": "paid"
                    },
                    "party": {
                        "name": "Global Distributors"
                    },
                    "details": {
                        "billNumber": "PUR-456",
                        "transactionDate": "2025-10-07T05:45:00Z"
                    },
                    "financials": {
                        "currency": "INR",
                        "totalAmount": 1200.00,
                        "paidAmount": 1200.00,
                        "due": 0.00
                    }
                },
                // --- NEW: Example where a supplier is also a customer ---
                {
                    "meta": {
                        "transactionId": "TRN-20251009-091500-789-IJKL",
                        "type": "sale", // This is a SALE to the supplier
                        "status": "paid"
                    },
                    "party": {
                        "name": "Global Distributors" // The same party from the purchase
                    },
                    "details": {
                        "billNumber": "SLE-124",
                        "transactionDate": "2025-10-09T09:15:00Z"
                    },
                    "financials": {
                        "currency": "INR",
                        "totalAmount": 300.00,
                        "paidAmount": 300.00,
                        "due": 0.00
                    }
                }
            ];

            function renderTransactions(transactions) {
                const container = document.getElementById('transaction-list-container');
                if (!container) return;

                if (transactions.length === 0) {
                    container.innerHTML = `<div class="placeholder-content" style="padding-top: 20px;"><i class="fas fa-receipt"></i><p>No transactions found.</p></div>`;
                    return;
                }

                const cardsHTML = transactions.map(tx => {
                    const { meta, party, details, financials } = tx;

                    // Format date and time
                    const date = new Date(details.transactionDate);
                    const formattedDateTime = date.toLocaleString('en-IN', {
                        month: 'short', day: 'numeric', year: 'numeric',
                        hour: 'numeric', minute: '2-digit', hour12: true
                    }).replace(',', '');

                    // Determine badge class and total amount class
                    const typeClass = meta.type === 'sale' ? 'sale' : 'purchase';
                    const totalAmountClass = meta.type === 'sale' ? 'success' : 'danger';

                    // Determine due amount class
                    let dueAmountClass = '';
                    if (financials.due > 0) {
                        dueAmountClass = 'due';
                    }

                    // Format amounts
                    const formattedTotal = new Intl.NumberFormat('en-IN', { style: 'currency', currency: financials.currency }).format(financials.totalAmount);
                    const formattedPaid = new Intl.NumberFormat('en-IN', { style: 'currency', currency: financials.currency }).format(financials.paidAmount);
                    const formattedDue = new Intl.NumberFormat('en-IN', { style: 'currency', currency: financials.currency }).format(financials.due);

                    return `
                        <div class="transaction-card" data-id="${meta.transactionId}">
                            <!-- Row 1: Party Name & Actions -->
                            <div class="transaction-row">
                                <span class="party-name">${party.name}</span>
                                <div class="transaction-actions">
                                    <button class="action-icon-btn" title="Print"><i class="fas fa-print"></i></button>
                                    <button class="action-icon-btn" title="Share"><i class="fas fa-share-alt"></i></button>
                                    <button class="action-icon-btn" title="More"><i class="fas fa-ellipsis-v"></i></button>
                                </div>
                            </div>
                            <!-- Row 2: Meta & Datetime -->
                            <div class="transaction-row">
                                <div class="transaction-meta">
                                    <span class="transaction-badge ${typeClass}">${meta.type}</span>
                                    <span class="bill-no">#${details.billNumber}</span>
                                </div>
                                <span class="transaction-datetime">${formattedDateTime}</span>
                            </div>
                            <!-- Row 3: Financials -->
                            <div class="transaction-row transaction-financials">
                                <span>Total: <span class="amount ${totalAmountClass}">${formattedTotal}</span></span>
                                <span class="text-center">Paid: <span class="amount success">${formattedPaid}</span></span>
                                <span class="text-right">Due: <span class="amount ${dueAmountClass}">${formattedDue}</span></span>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = cardsHTML;
            }

            // --- NEW: Function to render inventory items ---
            function renderInventory(inventory, filter = 'all') {
                const container = document.getElementById('inventory-list-container');
                if (!container) return;

                let filteredInventory = inventory;
                if (filter === 'product' || filter === 'service') {
                    filteredInventory = inventory.filter(item => item.meta.type === filter);
                }

                if (filteredInventory.length === 0) {
                    container.innerHTML = `<div class="placeholder-content" style="padding-top: 20px;"><i class="fas fa-boxes"></i><p>No items found for this filter.</p></div>`;
                    return;
                }

                const cardsHTML = filteredInventory.map(item => {
                    const { meta, info, pricing, inventory, media } = item;

                    const isService = meta.type === 'service';
                    const stockQty = inventory.stockQty;
                    const lowStockThreshold = inventory.lowStockThreshold || 10;
                    const isLowStock = !isService && stockQty !== null && stockQty < lowStockThreshold;

                    const stockQtyDisplay = isService ? 'N/A' : (stockQty !== null ? stockQty : 'N/A');
                    const stockLabel = isService ? 'Service' : 'in stock';

                    return `
                        <div class="content-card">
                            <img src="${media.thumbnail || './localstore/images/default-product.jpg'}" alt="${info.name}" class="inventory-item-thumb">
                            <div class="content-card-details">
                                <div class="content-card-title">${info.name}</div>
                                <div class="content-card-subtitle">Price: ${pricing.sellingPrice}</div>
                            </div>
                            <div class="inventory-stock">
                                <div class="stock-qty ${isLowStock ? 'low-stock' : ''}">${stockQtyDisplay}</div>
                                <div class="stock-label">${stockLabel}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = cardsHTML;
            }

            // --- NEW: Listener for inventory filter buttons ---
            document.querySelectorAll('.add-scrollable-content[data-tab="inventory"] .filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const filter = this.dataset.inventoryFilter;
                    if (filter !== 'advanced') {
                        renderInventory(dummyInventory, filter);
                    }
                });
            });
            // --- REFACTORED: Function to render parties based on filter ---
            function renderParties(filter = 'all') { // 'all', 'customer', 'supplier'
                const container = document.getElementById('party-list-container');
                const placeholderText = 'No parties found.';
                const defaultIcon = 'fa-user-circle';

                if (!container) return;

                // 1. Filter transactions based on the selected party filter
                let relevantTransactions;
                if (filter === 'customer') {
                    relevantTransactions = dummyTransactions.filter(tx => tx.meta.type === 'sale');
                } else if (filter === 'supplier') {
                    relevantTransactions = dummyTransactions.filter(tx => tx.meta.type === 'purchase');
                } else {
                    relevantTransactions = dummyTransactions; // 'all'
                }

                if (relevantTransactions.length === 0) {
                    container.innerHTML = `<div class="placeholder-content" style="padding-top: 20px;"><i class="fas ${defaultIcon}"></i><p>${placeholderText}</p></div>`;
                    return;
                }

                // 2. Create a map of unique parties and their last transaction date
                const partiesMap = new Map();
                relevantTransactions.forEach(tx => {
                    const partyName = tx.party.name;
                    const partyType = tx.meta.type; // 'sale' or 'purchase'
                    const txDate = new Date(tx.details.transactionDate);

                    if (!partiesMap.has(partyName)) {
                        // Initialize with balance
                        partiesMap.set(partyName, { lastDate: txDate, types: new Set(), balance: 0 });
                    }
                    const existing = partiesMap.get(partyName);
                    existing.types.add(partyType);
                    existing.balance += (partyType === 'sale' ? tx.financials.due : -tx.financials.due);
                    if (txDate > existing.lastDate) { // Update last transaction date
                        existing.lastDate = txDate;
                    }
                });

                // 3. Generate HTML for each unique party card
                const partyCardsHTML = Array.from(partiesMap.entries()).map(([name, data]) => {
                    const now = new Date();
                    const lastDate = data.lastDate;
                    const diffTime = Math.abs(now - lastDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    let subtitle = '';
                    if (diffDays <= 1) subtitle = `Last transaction: Today`;
                    else if (diffDays === 2) subtitle = `Last transaction: Yesterday`;
                    else if (diffDays <= 7) subtitle = `Last transaction: ${diffDays-1} days ago`;
                    else if (diffDays <= 30) subtitle = `Last transaction: ${Math.floor((diffDays-1)/7)} weeks ago`;
                    else subtitle = `Last transaction: ${new Date(lastDate).toLocaleDateString('en-GB')}`;

                    // Determine balance display
                    let balanceHTML = '';
                    let balanceLabelHTML = '';
                    if (data.balance !== 0) {
                        const balance = Math.abs(data.balance);
                        // Positive balance means party owes us (Receivable -> Danger/Red)
                        // Negative balance means we owe the party (Payable -> Success/Green)
                        const balanceClass = data.balance > 0 ? 'danger' : 'success';
                        const balanceLabel = data.balance > 0 ? 'Receivable' : 'Payable';
                        balanceHTML = `<div class="party-balance-amount content-card-amount ${balanceClass}">${balance.toLocaleString('en-IN')}</div>`;
                        balanceLabelHTML = `<div class="party-balance-label">${balanceLabel}</div>`;
                    } else {
                        // NEW: Handle zero balance case for consistent layout
                        balanceHTML = `<div class="party-balance-amount" style="color: var(--text-secondary);">00</div>`;
                        balanceLabelHTML = `<div class="party-balance-label" style="color: var(--text-secondary);">Settled</div>`;
                    }

                    // Determine icon based on party type(s)
                    let iconClass;
                    // NEW LOGIC (as per user feedback): Prioritize supplier. If a party has ANY purchase transaction, they are a supplier.
                    // Only show customer icon if they have ONLY sale transactions.
                    if (data.types.has('purchase')) {
                        iconClass = 'fa-user-tie'; // Supplier (or both, but supplier icon takes priority)
                    } else {
                        iconClass = 'fa-user'; // Customer only
                    }

                    return `
                        <div class="content-card">
                            <div class="content-card-icon"><i class="fas ${iconClass}"></i></div>
                            <!-- RESTRUCTURED: Details are now in a 2-row layout -->
                            <div class="content-card-details">
                                <div class="party-details-row">
                                    <div class="content-card-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${name}</div>
                                    ${balanceHTML}
                                </div>
                                <div class="party-details-row">
                                    <div class="content-card-subtitle">${subtitle}</div>
                                    ${balanceLabelHTML}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = partyCardsHTML;
            }

            let activeTabIndex = 0;
            let activeTabId = 'transactions';

            // --- FAB & Speed Dial Logic ---
            function updateFabOptions() {
                const actions = fabActions[activeTabId] || [];
                fabOptionsContainer.innerHTML = actions.map(action => `
                    <div class="fab-option-item">
                        <span class="fab-option-label">${action.label}</span>
                        <div class="fab-option-icon"><i class="${action.icon}"></i></div>
                    </div>
                `).join('');
            }

            function toggleFabMenu(forceState) {
                const isOpen = fabContainer.classList.contains('open');
                const shouldOpen = forceState !== undefined ? forceState : !isOpen;

                if (shouldOpen) {
                    fabContainer.classList.add('open');
                    fabMain.classList.add('open');
                    fabOverlay.classList.add('visible');
                } else {
                    fabContainer.classList.remove('open');
                    fabMain.classList.remove('open');
                    fabOverlay.classList.remove('visible');
                }
            }

            fabMain.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFabMenu();
            });

            fabOverlay.addEventListener('click', () => {
                toggleFabMenu(false);
            });

            fabOptionsContainer.addEventListener('click', (e) => {
                const optionItem = e.target.closest('.fab-option-item');
                if (optionItem) {
                    const label = optionItem.querySelector('.fab-option-label').textContent;
                    console.log(`Action clicked: ${label}`);
                    // Here you would trigger the actual action, e.g., opening a new form/view
                    alert(`Action: ${label}`);
                    toggleFabMenu(false);
                }
            });

            // --- Tab Switching Logic ---

            function updateIndicator(activeTab) {
                tabIndicator.style.width = `${activeTab.offsetWidth}px`;
                tabIndicator.style.left = `${activeTab.offsetLeft}px`;
            }

            function switchTab(index) {
                if (index < 0 || index >= tabButtons.length) return;

                const newActiveTab = tabButtons[index];
                activeTabId = newActiveTab.dataset.tab;
                
                // Update button active state
                tabButtons.forEach(btn => btn.classList.remove('active'));
                newActiveTab.classList.add('active');

                // Update indicator position
                updateIndicator(newActiveTab);

                // Scroll tab into view
                newActiveTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });

                // Slide content panes
                const offset = -index * 100;
                contentPanes.forEach(pane => {
                    pane.style.transform = `translateX(${offset}%)`;
                });

                activeTabIndex = index;

                // --- NEW: Render content for specific tabs when they become active ---
                if (activeTabId === 'parties') {
                    renderParties(); // Render with default 'all' filter
                } else if (activeTabId === 'inventory') {
                    renderInventory(dummyInventory); // Render with default 'all' filter
                }


                // Update the FAB options for the new tab
                updateFabOptions();
            }

            function updateIndicator(activeTab) {
                tabIndicator.style.width = `${activeTab.offsetWidth}px`;
                tabIndicator.style.left = `${activeTab.offsetLeft}px`;
            }

            // Initialize
            const initialActiveTab = document.querySelector('.tab-btn.active');
            if (initialActiveTab) {
                activeTabIndex = Array.from(tabButtons).indexOf(initialActiveTab);
                updateIndicator(initialActiveTab);
                switchTab(activeTabIndex); // Set initial content position
                updateFabOptions(); // Initial FAB options
            }

            // --- Initial Render Call ---
            tabsContainer.addEventListener('click', (e) => {
                const clickedTab = e.target.closest('.tab-btn');
                if (clickedTab) {
                    switchTab(Array.from(tabButtons).indexOf(clickedTab));
                }
            });
            renderTransactions(dummyTransactions);

            // --- NEW: Inventory Filter Button Listeners ---
            document.querySelectorAll('.add-scrollable-content[data-tab="inventory"] .filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const filter = this.dataset.inventoryFilter;

                    // If the advanced filter icon is clicked, handle it separately.
                    if (filter === 'advanced') {
                        const inventoryFilterPanel = document.getElementById('inventory-filter-panel');
                        const inventoryFilterOverlay = document.getElementById('inventory-filter-overlay');
                        inventoryFilterPanel.classList.add('visible');
                        inventoryFilterOverlay.classList.add('visible');
            
                        document.getElementById('inventory-filter-close-btn').onclick = () => {
                            inventoryFilterPanel.classList.remove('visible');
                            inventoryFilterOverlay.classList.remove('visible');
                        };
                        inventoryFilterOverlay.onclick = () => {
                            inventoryFilterPanel.classList.remove('visible');
                            inventoryFilterOverlay.classList.remove('visible');
                        };
                        // Do not change the primary filter's active state.
                        return;
                    }
            
                    // For primary filters (All, Products, Services), update the active state and re-render.
                    updateActiveFilterButton(this);
                    renderInventory(dummyInventory, filter);
                });
            });

            // --- NEW: Event listeners for the newly added filter bars ---

            // Listener for Posts Tab
            document.querySelectorAll('.add-scrollable-content[data-tab="posts"] .filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const filter = this.dataset.contentFilter;
                    if (filter === 'advanced') {
                        // Handle advanced filter separately, maybe open a modal
                        console.log('Advanced Posts filter clicked. Not changing primary active state.');
                        return;
                    }
                    updateActiveFilterButton(this);
                });
            });

            // Listener for Offers Tab
            document.querySelectorAll('.add-scrollable-content[data-tab="offers"] .filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    updateActiveFilterButton(this);
                    console.log('Offer filter clicked:', this.dataset.offerFilter);
                });
            });

            // Listener for Banners Tab
            document.querySelectorAll('.add-scrollable-content[data-tab="banners"] .filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    updateActiveFilterButton(this);
                    console.log('Banner filter clicked:', this.dataset.bannerFilter);
                });
            });
            // --- NEW: Function to check if party filters are active ---
            function arePartyFiltersActive() {
                const selectedSort = document.querySelector('input[name="party_sort"]:checked');
                return selectedSort && selectedSort.value !== 'name_asc'; // 'name_asc' is the default
            }

            function updatePartyFilterIcon() {
                document.querySelector('.filter-btn[data-party-filter="advanced"]').classList.toggle('active', arePartyFiltersActive());
            }

            // --- NEW: Party Filter Button Listeners ---
            // FIX: Make selector more specific to only target party filters
            document.querySelectorAll('.add-scrollable-content[data-tab="parties"] .filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const newFilter = this.dataset.partyFilter;
                    
                    // --- NEW: Open the party filter panel ---
                    if (newFilter === 'advanced') {
                        const partyFilterPanel = document.getElementById('party-filter-panel');
                        const partyFilterOverlay = document.getElementById('party-filter-overlay');
                        
                        // Toggle Panel
                        const isVisible = partyFilterPanel.classList.contains('visible');
                        if (isVisible) {
                            partyFilterPanel.classList.remove('visible');
                            partyFilterOverlay.classList.remove('visible');
                        } else {
                            partyFilterPanel.classList.add('visible');
                            partyFilterOverlay.classList.add('visible');
                        }

                        // Add close listeners if not already added
                        document.getElementById('party-filter-close-btn').onclick = () => {
                            partyFilterPanel.classList.remove('visible');
                            partyFilterOverlay.classList.remove('visible');
                        };
                        partyFilterOverlay.onclick = () => {
                            partyFilterPanel.classList.remove('visible');
                            partyFilterOverlay.classList.remove('visible');
                        };
                        return;
                    }
                    // Update active state
                    document.querySelectorAll('.filter-btn[data-party-filter]').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    // Re-render the party list with the new filter
                    renderParties(this.dataset.partyFilter);
                });
            });

            // --- NEW: Party Filter Panel Apply/Reset Logic ---
            document.getElementById('party-filter-apply-btn').addEventListener('click', () => {
                const selectedSort = document.querySelector('input[name="party_sort"]:checked').value;
                // In a real app, you would re-fetch/re-sort data here based on `selectedSort`
                console.log('Applying party sort:', selectedSort);
                updatePartyFilterIcon();
                document.getElementById('party-filter-panel').classList.remove('visible');
                document.getElementById('party-filter-overlay').classList.remove('visible');
            });

            document.getElementById('party-filter-reset-btn').addEventListener('click', () => {
                document.querySelector('input[name="party_sort"][value="name_asc"]').checked = true;
                console.log('Resetting party sort to default.');
                updatePartyFilterIcon();
                document.getElementById('party-filter-panel').classList.remove('visible');
                document.getElementById('party-filter-overlay').classList.remove('visible');
            });

            // --- NEW: Function to check if inventory filters are active ---
            function areInventoryFiltersActive() {
                const selectedSort = document.querySelector('input[name="inventory_sort"]:checked');
                return selectedSort && selectedSort.value !== 'stock_desc'; // 'stock_desc' is the default
            }

            function updateInventoryFilterIcon() {
                document.querySelector('.filter-btn[data-inventory-filter="advanced"]').classList.toggle('active', areInventoryFiltersActive());
            }

            // --- NEW: Inventory Filter Panel Apply/Reset Logic (Placeholder) ---
            document.getElementById('inventory-filter-apply-btn').addEventListener('click', () => {
                // In a real app, you would re-fetch/re-sort data here
                const selectedSort = document.querySelector('input[name="inventory_sort"]:checked').value;
                console.log('Applying inventory sort:', selectedSort);
                updateInventoryFilterIcon();
                document.getElementById('inventory-filter-panel').classList.remove('visible');
                document.getElementById('inventory-filter-overlay').classList.remove('visible');
            });

            document.getElementById('inventory-filter-reset-btn').addEventListener('click', () => {
                document.querySelector('input[name="inventory_sort"][value="stock_desc"]').checked = true;
                console.log('Resetting inventory sort to default.');
                updateInventoryFilterIcon();
                document.getElementById('inventory-filter-panel').classList.remove('visible');
                document.getElementById('inventory-filter-overlay').classList.remove('visible');
            });

            // --- NEW: Centralized function to update active state across ALL filter bars ---
            // This is the key fix for the inconsistent highlighting issue.
            function updateActiveFilterButton(clickedButton) {
                // 1. Find the specific filter bar containing the clicked button.
                const parentFilterBar = clickedButton.closest('.content-filter-bar');
                if (!parentFilterBar) return;

                // 2. Remove 'active' class ONLY from buttons within that specific bar.
                parentFilterBar.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                
                // 3. Add 'active' class ONLY to the button that was clicked.
                clickedButton.classList.add('active');
            }

            // --- NEW: Filter Button Listeners ---
            // FIX: Make selector more specific to only target transaction filters
            document.querySelectorAll('.add-scrollable-content[data-tab="transactions"] .filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // 1. Update active class for the button
                    const newFilter = this.dataset.filter;

                    // If date filter button is clicked, just open the panel
                    if (newFilter === 'date') {
                        toggleDateFilterPanel(true);
                        return; // Stop here, don't change active states
                    }

                    // --- FIX: When switching primary filters, keep the date filter icon active if a date filter is set. ---
                    // This ensures the calendar icon stays highlighted, indicating the date filter is still applied.
                    updateActiveFilterButton(this);

                    // Update the primary filter state
                    currentFilters.primary = newFilter;

                    applyAllFiltersAndRender();
                });
            });

            // --- NEW: Date Filter Panel Logic ---
            function toggleDateFilterPanel(show) {
                if (show) {
                    dateFilterPanel.classList.add('visible');
                    dateFilterOverlay.classList.add('visible');
                } else {
                    // When hiding, clear any active preset buttons
                    document.querySelectorAll('.date-filter-options .date-filter-btn.active').forEach(btn => {
                        btn.classList.remove('active');
                    });

                    // And re-apply the active class based on the current filter state
                    if (currentFilters.date?.range) {
                        const activePresetBtn = document.querySelector(`.date-filter-options .date-filter-btn[data-range="${currentFilters.date.range}"]`);
                        if (activePresetBtn) activePresetBtn.classList.add('active');
                    }

                    dateFilterPanel.classList.remove('visible');
                    dateFilterOverlay.classList.remove('visible');
                }
            }

            dateFilterCloseBtn.addEventListener('click', () => toggleDateFilterPanel(false));
            dateFilterOverlay.addEventListener('click', () => toggleDateFilterPanel(false));

            // --- FIX: Make the selector more specific to only target preset range buttons ---
            document.querySelectorAll('.date-filter-options .date-filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Visually update active preset button
                    document.querySelectorAll('.date-filter-options .date-filter-btn.active').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');

                    const range = this.dataset.range;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    let startDate, endDate = new Date();
                    endDate.setHours(23, 59, 59, 999);

                    switch(range) {
                        case 'today':
                            startDate = today;
                            break;
                        case 'yesterday':
                            startDate = new Date(today);
                            startDate.setDate(today.getDate() - 1);
                            endDate = new Date(startDate);
                            endDate.setHours(23, 59, 59, 999);
                            break;
                        case 'this_week':
                            startDate = new Date(today);
                            startDate.setDate(today.getDate() - today.getDay());
                            break;
                        case 'this_month':
                            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                            break;
                    }                    
                    // Clear custom date inputs when a preset is chosen
                    startDateInput.value = '';
                    endDateInput.value = '';

                    // FIX: Do not apply filter or close panel here. Just stage the selection.
                    // The "Apply" button will handle the logic.
                });
            });
            // --- FIX: When a date filter is applied, also update the active filter button ---
            function setActiveFilterButton(filterName, isDateFilterActive = false) {
                filterButtons.forEach(btn => {
                    if (btn.dataset.filter === 'date') {
                        btn.classList.toggle('active', isDateFilterActive);
                    } else {
                        btn.classList.toggle('active', btn.dataset.filter === filterName);
                    }
                });
            }

            // --- NEW: Update display when a date is selected ---
            const startDateInput = document.getElementById('date-filter-start');
            const endDateInput = document.getElementById('date-filter-end');
            const startDateDisplay = document.getElementById('date-display-start');
            const endDateDisplay = document.getElementById('date-display-end');

            startDateInput.addEventListener('change', function() {
                const startDate = this.value;
                startDateDisplay.querySelector('span').textContent = startDate ? new Date(startDate).toLocaleDateString('en-GB') : 'Start Date';

                // When a custom date is changed, clear the active state from preset buttons
                document.querySelectorAll('.date-filter-options .date-filter-btn.active').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (currentFilters.date) currentFilters.date.range = 'custom';

                // --- FIX: Prevent end date from being before start date ---
                endDateInput.min = startDate; // Set the minimum allowed end date
                if (endDateInput.value && endDateInput.value < startDate) {
                    endDateInput.value = startDate; // Auto-correct the end date
                    endDateDisplay.querySelector('span').textContent = new Date(startDate).toLocaleDateString('en-GB');
                }
            });

            endDateInput.addEventListener('change', function() {
                const endDate = this.value;
                endDateDisplay.querySelector('span').textContent = endDate ? new Date(endDate).toLocaleDateString('en-GB') : 'End Date';

                // When a custom date is changed, clear the active state from preset buttons
                document.querySelectorAll('.date-filter-options .date-filter-btn.active').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (currentFilters.date) currentFilters.date.range = 'custom';

                // --- FIX: Prevent start date from being after end date ---
                if (startDateInput.value && startDateInput.value > endDate) {
                    startDateInput.value = endDate; // Auto-correct the start date
                    startDateDisplay.querySelector('span').textContent = new Date(endDate).toLocaleDateString('en-GB');
                }
            });

            // --- NEW: Reset button functionality ---
            document.getElementById('date-filter-reset-btn').addEventListener('click', () => {
                startDateInput.value = '';
                endDateInput.value = '';
                startDateDisplay.querySelector('span').textContent = 'Start Date';
                endDateDisplay.querySelector('span').textContent = 'End Date';
                document.querySelectorAll('.date-filter-options .date-filter-btn.active').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Reset filter state and re-render
                currentFilters.primary = 'all';
                currentFilters.date = null;
                setActiveFilterButton('all', false); // Set 'all' as active, and date icon as inactive

                applyAllFiltersAndRender();
                toggleDateFilterPanel(false); // Close the panel
            });

            // --- REFACTORED: Apply button now updates state and calls the main filter function ---
            document.getElementById('date-filter-apply-btn').addEventListener('click', () => {
                // --- NEW: Centralized apply logic ---
                const startDateValue = startDateInput.value;
                const endDateValue = endDateInput.value;
                const activePresetBtn = document.querySelector('.date-filter-options .date-filter-btn.active');

                let newDateFilter = null;

                // Case 1: A preset button is active
                if (activePresetBtn) {
                    const range = activePresetBtn.dataset.range;
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    let startDate, endDate = new Date();
                    endDate.setHours(23, 59, 59, 999);

                    switch(range) {
                        case 'today':
                            startDate = today;
                            break;
                        case 'yesterday':
                            startDate = new Date(today);
                            startDate.setDate(today.getDate() - 1);
                            endDate = new Date(startDate);
                            endDate.setHours(23, 59, 59, 999);
                            break;
                        case 'this_week':
                            startDate = new Date(today);
                            startDate.setDate(today.getDate() - today.getDay());
                            break;
                        case 'this_month':
                            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                            break;
                    }
                    if (startDate && endDate) {
                        newDateFilter = { startDate, endDate, range: range };
                    }
                } 
                // Case 2: Custom date range is selected
                else if (startDateValue && endDateValue) {
                    newDateFilter = {
                        startDate: new Date(startDateValue),
                        endDate: new Date(endDateValue),
                        range: 'custom'
                    };
                }

                currentFilters.date = newDateFilter;
                // --- FIX: Correctly highlight the date icon if a date filter is applied ---
                const dateIconBtn = document.querySelector('.add-scrollable-content[data-tab="transactions"] .filter-btn[data-filter="date"]');
                if (dateIconBtn) {
                    dateIconBtn.classList.toggle('active', !!newDateFilter);
                }
                applyAllFiltersAndRender();
                toggleDateFilterPanel(false);
            });

            // Swipe listeners
            let touchStartX = 0;
            let touchEndX = 0;

            contentContainer.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            contentContainer.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });

            function handleSwipe() {
                const swipeThreshold = 50; // Minimum pixels for a swipe
                if (touchEndX < touchStartX - swipeThreshold) {
                    // Swiped left
                    switchTab(activeTabIndex + 1);
                }
                if (touchEndX > touchStartX + swipeThreshold) {
                    // Swiped right
                    switchTab(activeTabIndex - 1);
                }
            }

        });

        // --- NEW: Horizontal Mouse Wheel Scroll for Scrollable Bars ---
        function enableHorizontalScroll(selector) {
            const element = document.querySelector(selector);
            if (element) {
                element.addEventListener('wheel', (e) => {
                    // Prevent the default vertical scroll when scrolling over the element
                    e.preventDefault();
                    // Scroll the element horizontally instead
                    element.scrollLeft += e.deltaY;
                }, { passive: false });
            }
        }

        enableHorizontalScroll('.content-filter-bar'); // For the filter bar
        enableHorizontalScroll('.add-primary-tabs');     // For the top tabs
    </script>
</body>
</html>