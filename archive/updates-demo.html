<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>mStore - Updates</title>
<link rel="stylesheet" href="../source/common/styles/theme.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  body{
    margin:0;
    background:var(--bg-primary);
    --bg-primary: #121212; /* Demo के लिए डार्क मोड */
  }
  .updates-container {
    display:flex;
    flex-direction:column;
    height:100vh;
    overflow:hidden;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    color:var(--text-primary);
    -webkit-font-smoothing:antialiased; 
  }

  .subscription-content {
    flex-grow: 1; /* Take remaining vertical space */
    overflow-y: auto; /* Enable vertical scrolling */
    padding: 0 12px; /* Add horizontal padding */
  }

  /* Stories row */
  .story-container {
    display:flex;
    flex-shrink: 0; /* Prevent stories row from shrinking */
    gap:12px;
    padding:8px 4px;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:none;
  }
  .story-container::-webkit-scrollbar {
    display:none;
  }
  .story-item {
    display:flex;
    flex-direction:column;
    align-items:center;
    width:72px;
    flex:0 0 auto;
    text-align:center;
    font-size:12px;
    gap:6px;
    cursor:pointer;
  }


  .avatar-wrap {
    width:68px;
    height:68px;
    border-radius:50%;
    display:grid;
    place-items:center;
    position:relative;
    background:var(--bg-secondary);
    border: 2px solid var(--border-color);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    flex-shrink: 0; /* Prevent the avatar from shrinking */
  }
  
  .story-item.active .avatar-wrap {
    border: 2px solid var(--accent-primary);
    box-shadow: var(--shadow-glow-accent);
    background: var(--bg-secondary);
    -webkit-background-clip: initial;
    background-clip: initial;
  }

  /* NEW & IMPORTANT: Specific rule for an ACTIVE story that HAS a story.
     This ensures the blue border overrides the gradient ring. */
  .story-item.has-story.active .avatar-wrap {
    border: 2px solid var(--accent-primary); /* Force the blue border */
    background: var(--bg-secondary);
    -webkit-background-clip: initial;
    background-clip: initial; 
    box-shadow: var(--shadow-glow-accent);
  }

  .story-item.active .avatar-name {
    color: var(--accent-primary);
    font-weight: 600;
  }

  .story-avatar {
    width:100%;
    height:100%;
    border-radius:50%;
    object-fit:cover;
    background: #333;
    display:block;
    border: 2px solid var(--bg-primary);
    box-sizing: border-box;
  }

  .has-story .avatar-wrap {
    border: 2px solid transparent;
    background: var(--story-ring-gradient) border-box;
    -webkit-background-clip: border-box;
    background-clip: border-box;
    box-shadow: var(--shadow-glow-accent);
    animation: pulse-ring 2s infinite;
  }
  
  .story-item.viewed .avatar-wrap {
    border: 2px solid transparent;
    background: var(--story-ring-viewed-gradient) border-box;
    -webkit-background-clip: border-box;
    background-clip: border-box;
    animation: none;
    box-shadow: none;
  }

  .avatar-name {
    max-width:74px;
    overflow:hidden;
    white-space:nowrap;
    text-overflow: ellipsis;
    color:var(--text-secondary);
  }
  
  .story-item.my-story .avatar-wrap {
    background: var(--bg-secondary); /* No story ring for self */
  }

  .story-item .add-story-btn {
    position: absolute;
    bottom: 0px;
    right: 0px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;}

  .story-item .add-story-btn i {
    color: var(--border-color);
    font-size: 15px;
  }

  .segmented-controls {
    display:flex;
    gap:8px;
    flex-shrink: 0;
    margin: 0px 12px 12px 12px; /* Increased bottom margin for more space */
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;  /* IE and Edge */
  }
  .segmented-controls::-webkit-scrollbar {
    display: none; /* Chrome, Safari, and Opera */
  }
  .segmented-controls button{
    /* Styles copied from account.css .action-btn */
    background: var(--bg-primary);
    color: var(--text-primary);
    border: 1px solid var(--text-primary);
    background: var(--bg-secondary);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    padding: 5px 12px; /* Adjusted padding slightly for better look */
    border-radius: 20px;
    font-size: 12px;
    cursor:pointer;
    transition: all 0.3s;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .segmented-controls button:hover {
    background: rgba(var(--accent-primary-rgb), 0.1);
    color: var(--accent-primary);
  }
  .segmented-controls button.active{
    background:var(--accent-primary);
    color:var(--accent-text);
    border-color: var(--accent-primary); /* Match border color on active */
  }

  .feed-grid {
    display:grid;
    grid-template-columns: repeat(2,1fr);
    gap:12px;
  }
  .feed-card {
    background:var(--bg-secondary);
    border-radius:10px;
    overflow:hidden;
    padding:8px;
    transition:transform 0.2s ease;
    cursor:pointer;
    border: 1px solid rgba(255,255,255,0.05);
  }
  .feed-card:hover {
    transform:translateY(-4px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  .feed-card img{ width:100%; height:120px; object-fit:cover; border-radius:6px; display:block }
  .feed-card .card-title{ font-size:14px; margin-top:8px; color:var(--text-primary) }
  .feed-card .card-price{ color:var(--accent-success); margin-top:4px; font-weight:600 }

  /* Enhanced Merchant page */
  .merchant-page {
    display:none;
    flex-direction:column;
    gap:8px;
  }
  .merchant-header {
    display:flex;
    gap:12px;
    align-items:center;
    padding:8px 6px;
    background: var(--bg-secondary);
    border-radius: 10px;
    margin-bottom: 10px;
  }
  .merchant-header img{ 
    width:64px; 
    height:64px; 
    border-radius:50%; 
    border: 2px solid var(--accent-primary);
    box-shadow: var(--shadow-glow-accent);
  }

  .merchant-actions {
    display: flex;
    gap: 10px;
    margin: 10px 0;
  }
  
  .action-btn {
    flex: 1;
    padding: 8px 14px;
    border-radius: 20px;
    border: 1px solid transparent;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 14px;
    white-space: nowrap;
  }

  .action-btn:active {
    transform: scale(0.98);
  }
  
  .action-btn.primary {
    background: var(--accent-primary);
    color: var(--accent-text);
    border-color: var(--accent-primary);
  }
  
  .action-btn.secondary {
    background: transparent;
    color: var(--text-secondary);
    border-color: var(--text-secondary);
  }
  
  .action-btn:hover {
    filter: brightness(1.15);
  }

  .action-btn.secondary:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  @media (max-width:480px){
    .feed-grid { grid-template-columns: repeat(1,1fr); }
    .avatar-wrap { width:62px; height:62px; }
    .feed-grid { grid-template-columns: repeat(2,1fr); } /* On smaller phones, 2 columns look better */
  }

  /* Loading spinner for infinite scroll */
  #feed-loader {
    text-align: center;
    padding: 20px;
    color: var(--text-secondary);
  }
</style>
<body class="dark-mode"> <!-- Force dark mode for this demo page -->
<body>
  <div class="updates-container">
      <!-- Stories row -->
      <div class="story-container" id="storiesRow" aria-label="Merchant stories">
        <!-- JS will populate -->
      </div>

      <!-- Enhanced Segmented filters -->
      <div class="segmented-controls" role="tablist" aria-label="filters">
        <button id="filterAll" class="active">All</button>
        <button id="filterToday">Today</button>
        <button id="filterPost">Post</button>
        <button id="filterOffers">Offers</button>
        <button id="filterPopular">Popular</button>
        <button id="filterNew">New</button>
      </div>
      
      <div class="subscription-content" id="updatesContentWrapper">
        <!-- Enhanced Merchant page (hidden by default) -->
        <div class="merchant-page" id="merchantPage">
          <div style="padding:6px;color:var(--text-secondary);font-size:13px">Latest Items</div>
          <div class="feed-grid" id="merchantFeed"></div>
        </div>

        <!-- Default feed -->
        <div id="defaultFeed">
          <div class="feed-grid" id="feedGrid"></div>
          <div id="feed-loader" class="hidden">Loading more...</div>
        </div>
      </div>
  </div>

  <div id="story-viewer-placeholder"></div>

<script>
  // Enhanced Demo data
  const merchants = [
    { 
      id: 1, 
      name: 'Internet Cafe', 
      avatar:'https://picsum.photos/seed/m1/200', 
      hasStory: true, 
      followedAt: new Date(Date.now() - 86400000 * 5), // Followed 5 days ago
      followers: '1.2K',
      stories:[
        { type:'img', src:'https://picsum.photos/seed/s11/1000/1600', duration: 5000 },
        { type:'img', src:'https://picsum.photos/seed/s12/1000/1600', duration: 5000 }
      ]
    },
    { 
      id: 2, 
      name: 'Anita Store', 
      avatar:'https://picsum.photos/seed/m2/200', 
      hasStory: true, 
      followedAt: new Date(Date.now() - 86400000 * 10), // Followed 10 days ago
      followers: '3.4K',
      stories:[
        { type:'img', src:'https://picsum.photos/seed/s21/1000/1600', duration: 5000 }
      ]
    },
    { 
      id: 3, 
      name: 'Ak Electrician', 
      avatar:'https://picsum.photos/seed/m3/200', 
      hasStory: false, 
      followedAt: new Date(Date.now() - 86400000 * 2), // Followed 2 days ago
      followers: '890',
      stories:[]
    },
    { 
      id: 4, 
      name: 'The Plumber', 
      avatar:'https://picsum.photos/seed/m4/200', 
      hasStory: true, 
      followedAt: new Date(Date.now() - 86400000 * 1), // Followed 1 day ago
      followers: '2.1K',
      stories:[
        { type:'img', src:'https://picsum.photos/seed/s41/1000/1600', duration: 5000 },
        { type:'img', src:'https://picsum.photos/seed/s42/1000/1600', duration: 5000 },
        { type:'img', src:'https://picsum.photos/seed/s43/1000/1600', duration: 5000 }
      ]
    },
    {
      id:5,
      name:'Quick Shop',
      avatar:'https://picsum.photos/seed/m5/200',
      hasStory:false,
      followedAt: new Date(Date.now() - 3600000), // Followed 1 hour ago
      followers: '1.5K',
      stories:[]
    },
    { 
      id: 6, 
      name: 'No Story User', 
      avatar: 'https://picsum.photos/seed/m6/200', 
      hasStory: false, 
      followedAt: new Date(Date.now() - 86400000 * 30), // Followed 30 days ago
      followers: '100',
      stories: []
    }
  ];

  const items = [
    {id:101, title:'Blue Jacket', price:'₹1299', img:'https://picsum.photos/seed/p1/800/600', merchantId:1, date: new Date(Date.now() - 86400000)},
    {id:102, title:'Sneakers', price:'₹1999', img:'https://picsum.photos/seed/p2/800/600', merchantId:2, date: new Date(Date.now() - 172800000)},
    {id:103, title:'Headphones', price:'₹899', img:'https://picsum.photos/seed/p3/800/600', merchantId:1, date: new Date(Date.now() - 259200000)},
    {id:104, title:'Notebook', price:'₹249', img:'https://picsum.photos/seed/p4/800/600', merchantId:3, date: new Date(Date.now() - 345600000)},
    {id:105, title:'Lamp', price:'₹499', img:'https://picsum.photos/seed/p5/800/600', merchantId:4, date: new Date(Date.now() - 432000000)},
    {id:106, title:'Bottle', price:'₹199', img:'https://picsum.photos/seed/p6/800/600', merchantId:2, date: new Date(Date.now() - 518400000)},
    {id:107, title:'Smart Watch', price:'₹3499', img:'https://picsum.photos/seed/p7/800/600', merchantId:1, date: new Date()},
    {id:108, title:'Wireless Earbuds', price:'₹1599', img:'https://picsum.photos/seed/p8/800/600', merchantId:4, date: new Date(Date.now() - 3600000)}, // 1 hour ago
    // Add more items for infinite scroll demo
    {id:109, title:'Backpack', price:'₹999', img:'https://picsum.photos/seed/p9/800/600', merchantId:5, date: new Date(Date.now() - 7200000)}, // 2 hours ago
    {id:110, title:'Coffee Mug', price:'₹349', img:'https://picsum.photos/seed/p10/800/600', merchantId:3, date: new Date(Date.now() - 86400000 * 3)},
    {id:111, title:'Desk Chair', price:'₹4999', img:'https://picsum.photos/seed/p11/800/600', merchantId:1, date: new Date(Date.now() - 86400000 * 4)},
    {id:112, title:'Sunglasses', price:'₹799', img:'https://picsum.photos/seed/p12/800/600', merchantId:2, date: new Date(Date.now() - 86400000 * 6)},
    {id:113, title:'Keyboard', price:'₹2199', img:'https://picsum.photos/seed/p13/800/600', merchantId:4, date: new Date(Date.now() - 86400000 * 7)},
    {id:114, title:'Mousepad', price:'₹499', img:'https://picsum.photos/seed/p14/800/600', merchantId:5, date: new Date(Date.now() - 86400000 * 8)},
  ];

  // DOM refs
  const updatesContainer = document.querySelector('.updates-container');
  const storiesRow = document.getElementById('storiesRow');
  const feedGrid = document.getElementById('feedGrid');
  const merchantPage = document.getElementById('merchantPage');
  const merchantFeed = document.getElementById('merchantFeed');
  const defaultFeed = document.getElementById('defaultFeed');
  const updatesContentWrapper = document.getElementById('updatesContentWrapper');
  const segmentedControls = document.querySelector('.segmented-controls');
  const feedLoader = document.getElementById('feed-loader');

  // state
  let currentMerchant = null;

  // render stories
  function renderStories(){
    storiesRow.innerHTML = '';

    // Add "My Status" element first
    const myStoryEl = document.createElement('div');
    myStoryEl.className = 'story-item my-story';
    myStoryEl.innerHTML = `
        <div class="avatar-wrap" role="button" tabindex="0" aria-label="Add to your story">
          <img class="story-avatar" src="https://i.pravatar.cc/200?u=currentUser" alt="My Status" />
          <div class="add-story-btn"><i class="fas fa-plus-circle"></i></div>
        </div>
        <div class="avatar-name">My Status</div>
    `;
    myStoryEl.querySelector('.avatar-wrap').addEventListener('click', () => {
        // Future: open story creation UI
        alert('Add Story feature coming soon!');
    });
    storiesRow.appendChild(myStoryEl);

    const oneDayAgo = Date.now() - 86400000;

    const getScore = (merchant) => {
      let score = 0;
      // Priority 1: Has a story
      if (merchant.hasStory) score += 1000;
      
      // Priority 2: Recently followed (within last 24 hours)
      if (merchant.followedAt > oneDayAgo) score += 500;

      // Priority 3: Has a new item (posted in last 24 hours)
      const hasNewItem = items.some(item => item.merchantId === merchant.id && item.date > oneDayAgo);
      if (hasNewItem) score += 100;

      // Final tie-breaker: most recent follow date
      score += merchant.followedAt.getTime() / 1e9; // Add timestamp to break ties

      return score;
    };

    const sortedMerchants = [...merchants].sort((a, b) => getScore(b) - getScore(a));
    storiesRow.setAttribute('data-rendered', 'true');

    sortedMerchants.forEach(m=>{
      const wrap = document.createElement('div');
      wrap.className = 'story-item' + (m.hasStory ? ' has-story' : '');
      wrap.setAttribute('data-id', m.id); // Set data-id on the parent story element
      wrap.innerHTML = `
        <div class="avatar-wrap" role="button" tabindex="0">
          <img class="story-avatar" src="${m.avatar}" alt="${m.name}" />
        </div>
        <div class="avatar-name">${m.name}</div>
      `;
      storiesRow.appendChild(wrap);
    });
  }

  let currentPage = 1;
  const itemsPerPage = 6;
  let isLoading = false;
  let allItemsLoaded = false;
  let currentFilterState = { type: 'all', merchantId: null };

  // render feed (all items)
  function renderFeed(filterMerchantId = null, filterType = 'all', page = 1){
    isLoading = true;
    let list = [...items]; // Use a copy to avoid modifying the original array
    
    // Filter by merchant if specified
    if(filterMerchantId) {
      list = list.filter(it => it.merchantId === filterMerchantId);
    }
    
    // Apply additional filters
    if(filterType === 'today') {
      const today = new Date();
      today.setHours(0,0,0,0);
      list = list.filter(it => it.date >= today);
    } else if(filterType === 'offers') {
      // For demo, items with price ending in 99 are offers
      list = list.filter(it => it.price.endsWith('99'));
    } else if(filterType === 'post') {
      // For demo, items with IDs > 105 are new posts
      list = list.filter(it => it.id > 105);
    }
    
    // Sort by date (newest first)
    list.sort((a, b) => b.date - a.date);
    
    const startIndex = (page - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedItems = list.slice(startIndex, endIndex);

    if (page === 1) {
      feedGrid.innerHTML = '';
      allItemsLoaded = false;
    }

    if (paginatedItems.length < itemsPerPage) {
      allItemsLoaded = true; // No more items to load
    }

    if(list.length === 0){
      feedGrid.innerHTML = `<div style="color:var(--text-secondary);padding:20px;text-align:center">No items found</div>`;
      return;
    }
    paginatedItems.forEach(it=>{
      const c = document.createElement('div');
      c.className = 'feed-card';
      c.innerHTML = `
        <img src="${it.img}" alt="${it.title}" />
        <div class="card-title">${it.title}</div>
        <div class="card-price">${it.price}</div>
      `;
      feedGrid.appendChild(c);
    });
    isLoading = false;
    feedLoader.classList.add('hidden');
  }

  // render merchant page
  function showMerchantPage(merchant){
    currentMerchant = merchant;

    document.querySelectorAll('.story-item.active').forEach(el => el.classList.remove('active'));
    const storyEl = storiesRow.querySelector(`.story-item[data-id='${merchant.id}']`);
    if (storyEl) {
      storyEl.classList.add('active');
      if (merchant.hasStory) {
        storyEl.classList.add('viewed');
      }
    }
    
    // Render latest items for this merchant
    renderMerchantFeed(merchant.id);
    
    merchantPage.style.display = 'flex';
    defaultFeed.style.display = 'none';
    segmentedControls.style.display = 'none';
    updatesContentWrapper.scrollTop = 0;
  }
  
  function renderMerchantFeed(merchantId) {
    merchantFeed.innerHTML = '';
    const related = items
      .filter(i => i.merchantId === merchantId)
      .sort((a, b) => b.date - a.date); // Sort by date, newest first
    
    if(related.length === 0){
      merchantFeed.innerHTML = `<div style="color:var(--text-secondary);padding:8px;text-align:center">No products yet.</div>`;
    } else {
      related.forEach(it=>{
        const c = document.createElement('div');
        c.className = 'feed-card';
        c.innerHTML = `
          <img src="${it.img}" alt="${it.title}" />
          <div class="card-title">${it.title}</div>
          <div class="card-price">${it.price}</div>
        `;
        merchantFeed.appendChild(c);
      });
    }
  }

  function hideMerchantPage(){
    merchantPage.style.display = 'none';
    defaultFeed.style.display = '';
    segmentedControls.style.display = 'flex';
    const activeStory = storiesRow.querySelector('.story-item.active');
    if (activeStory) activeStory.classList.remove('active');
    currentMerchant = null;
  }

  function onAvatarClick(merchant){
    showMerchantPage(merchant);
  }

  renderStories();
  renderFeed();

  function enableHorizontalScroll(element) {
    if (!element) return;
    element.addEventListener('wheel', (e) => {
      // If there's horizontal overflow
      if (element.scrollWidth > element.clientWidth) {
        if (e.deltaY !== 0) {
          // Prevent the default vertical scroll
          e.preventDefault();
          // Scroll horizontally instead
          element.scrollLeft += e.deltaY;
        }
      }
    });
  }
  enableHorizontalScroll(storiesRow);
  enableHorizontalScroll(segmentedControls);

  function handleFilterClick(filterType) {
    currentPage = 1; // Reset page number on new filter
    currentFilterState.type = filterType;
    currentFilterState.merchantId = null;
    renderFeed(null, filterType, currentPage);
  }

  document.querySelectorAll('.segmented-controls button').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.segmented-controls button').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      const id = this.id;
      if (currentMerchant) {
        hideMerchantPage();
      }
      
      const filterMap = {
        'filterAll': 'all',
        'filterToday': 'today',
        'filterPost': 'post',
        'filterOffers': 'offers',
        'filterPopular': 'all',
        'filterNew': 'all'
      };
      handleFilterClick(filterMap[id] || 'all');
    });
  });

  updatesContentWrapper.addEventListener('scroll', () => {
    if (defaultFeed.style.display === 'none' || isLoading || allItemsLoaded) return;

    if (updatesContentWrapper.scrollTop + updatesContentWrapper.clientHeight >= updatesContentWrapper.scrollHeight - 100) {
      feedLoader.classList.remove('hidden');
      currentPage++;
      renderFeed(currentFilterState.merchantId, currentFilterState.type, currentPage);
    }
  });

  storiesRow.addEventListener('click', (e)=>{
    // Ensure stories are rendered before processing clicks
    if (storiesRow.getAttribute('data-rendered') !== 'true') return;

    const storyWrap = e.target.closest('.story-item');
    if(!storyWrap) return;
    // find which merchant
    const id = storyWrap.getAttribute('data-id');
    if(id){
      const m = merchants.find(x => String(x.id) === String(id));
      if (m) {
        showMerchantPage(m);
      }
    }
  });

  document.addEventListener('keydown',(e)=>{
    if(e.key === 'Escape') {
      hideMerchantPage();
    }
  });

  updatesContainer.addEventListener('dblclick', ()=>{
    hideMerchantPage();
  });

</script>
</body>
</html>