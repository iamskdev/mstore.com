<!DOCTYPE html>
<html lang="hi"> 
<head>
  <!-- Set theme color for browser UI -->
  <meta charset="UTF-8"/>
  <!-- Dynamic Base URL for GitHub Pages (Adaptive) -->
  <base href="./"> 
  <meta name="viewport" id="viewport-meta" content="width=device-width, initial-scale=1.0" />
  <title>mStore - Online Marketplace</title>
  <link rel="icon" href="./source/assets/logos/app-logo.png" type="image/jpeg">
  <link rel="manifest" href="./manifest.json">
  <link rel="stylesheet" href="./source/common/styles/theme.css" />
   <link rel="stylesheet" href="./source/main.css" />
  <!-- Set theme color for browser UI -->
  <meta name="theme-color" id="theme-color-meta" content="#121212">
  <script>
    // This inline script runs before rendering to prevent a "flash of unstyled content" (FOUC).
    // It sets the theme class on the <html> element and updates the theme-color meta tag.
    (async function() {
      let appConfig = {};
      try {
        const response = await fetch('./source/settings/config.json');
        if (response.ok) {
          appConfig = await response.json();
        }
      } catch (error) {
        console.error("Error loading config.json in inline script:", error);
      }

      const configTheme = appConfig.ui?.theme;
      const preference = localStorage.getItem('app-theme');
      const systemIsDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

      // Priority: config.json -> localStorage -> system preference -> default 'light'
      const theme = configTheme || preference || (systemIsDark ? 'dark' : 'light');

      document.documentElement.classList.add(`${theme}-mode`);
      document.documentElement.dataset.theme = theme;

      // Define theme colors to avoid waiting for CSS. These must match --bg-primary in main.css.
      const themeColors = {
        light: '#fffffff',
        dark: '#000000'
      };

      // Update the meta tag immediately to ensure the status bar color is correct on initial load.
      const themeColorMeta = document.getElementById('theme-color-meta');
      if (themeColorMeta) {
        themeColorMeta.setAttribute('content', themeColors[theme]);
      }
    })();
</script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
 </head>
 <body id="main-body">
  <div class="splash-screen" id="splashScreen">
    <div class="splash-content">
      <img src="./source/assets/logos/app-logo.png" 
           class="splash-logo" 
           alt="mStore Logo"
           onerror="this.src='./source/assets/logos/app-logo.png'">
      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>
  </div>
 
 <!-- Page Loader -->
 <div class="view-loading hidden">
  <div class="spinner"></div>
</div>

<!-- ======================= -->
<!-- == DEFAULT LAYOUT ===== -->
<!-- ======================= -->
<div id="default-layout">
    <!-- Top Navigation: Always visible at top -->
    <nav id="top-nav" class="top-navigation"></nav>

    <!-- Header: Currently Use for Margin/padding -->
    <header id="app-header" class="header-view-area"></header>

    <!-- Main: Main content area -->
    <main id="main-content"></main>

    <!-- Footer: Currently Use for Margin/padding -->
    <footer id="app-footer" class="footer-view-area"></footer>

    <!-- Bottom Navigation: Always visible at bottom -->
    <nav id="bottom-nav" class="bottom-navigation"></nav>
</div>

<!-- ======================= -->
<!-- == FULLSCREEN LAYOUT === -->
<!-- ======================= -->
<div id="fullscreen-layout">
    <!-- Fullscreen pages will be loaded here -->
</div>

<!-- Drawer / Sidebar: Hidden toggle menu -->
<aside id="app-drawer" class="navigation-drawer"></aside>  

<div id="pullToRefresh">
    <!-- Arrow icon -->
    <span class="material-icons" id="arrowIcon">refresh</span>
    <!-- Spinner icon (hidden by default) -->
    <span class="material-icons" id="spinnerIcon" style="display:none;">autorenew</span>
  </div>

<!-- ======================= -->
<!-- == CUSTOM ALERT POPUP == -->
<!-- ======================= -->
<div id="custom-alert-popup" class="alert-overlay">
  <div class="alert-box">
    <h3 class="alert-title"></h3>
    <p class="alert-message"></p>
    <div class="alert-actions"></div>
  </div>
</div>


<!-- Dev Mode Switcher (should be last) -->
<div id="role-switcher-placeholder"></div>



  <!-- 8. Scripts -->
  <!-- This single module is the main entry point for the application's logic. -->
  <!-- It handles loading all other necessary components and scripts in the correct order. -->
<script>
    const progressBar = document.getElementById('progressBar');
    const splashScreen = document.getElementById('splashScreen');
    // Progress bar animation will be controlled by main.js
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module">
  // ‚úÖ Import critical modules at the top.
  import { getAppConfig } from './source/settings/main-config.js';
  import { initializePwaInstall, setDeferredPrompt, getDeferredPrompt } from './source/utils/pwa-manager.js';
  // Import the main app initializer, but don't run it yet.
  import { initializeApp } from './source/main.js';

    // --- PWA Install Prompt Handling ---
    // This listener captures the event that allows the app to be installed.
    // It prevents the default browser prompt and saves the event for later use.
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      // Stash the event so it can be triggered later.
      setDeferredPrompt(e);
      // Dispatch a custom event to notify UI components that the app is installable.
      // This is better than directly manipulating the DOM from here.
      window.dispatchEvent(new CustomEvent('pwaInstallReady'));
      console.log('`beforeinstallprompt` event was fired and captured.');
    });

  // --- Service Worker Registration (Early) ---
  // Register service worker as early as possible for better offline handling
  if ('serviceWorker' in navigator) {
    // Check if service worker is already controlling the page
    if (navigator.serviceWorker.controller) {
      console.log('‚ÑπÔ∏è Service Worker already controlling the page');
    } else {
      console.log('üîÑ Registering Service Worker...');
    }

    // Register service worker early
    navigator.serviceWorker.register('./service-worker.js', { type: 'module' })
      .then(registration => {
        console.log('‚úÖ Service Worker registered early:', registration);

        // Wait for the service worker to be ready
        return navigator.serviceWorker.ready;
      })
      .then(registration => {
        console.log('‚úÖ Service Worker ready and controlling page');
      })
      .catch(error => {
        console.error('‚ùå Early Service Worker registration failed:', error);
      });
  }

  // 2. Initialize the main application.
  initializeApp()
    .then(() => {
      console.log("‚úÖ Application initialized successfully.");

      // --- Service Worker Management (Detailed) ---
      if ('serviceWorker' in navigator) {
        const appConfig = getAppConfig();

        // Log the currently active service worker's version if it exists
        if (navigator.serviceWorker.controller) {
          console.log(`‚ÑπÔ∏è Active Service Worker Script URL: ${navigator.serviceWorker.controller.scriptURL}`);
        }

        // Check if we already registered above, just update status
        navigator.serviceWorker.getRegistrations().then(registrations => {
          const existingRegistration = registrations.find(reg => reg.active);

          if (existingRegistration) {
            console.log('‚úÖ Service Worker already active');
            // Request cache name from active service worker
            const messageChannel = new MessageChannel();
            messageChannel.port1.onmessage = (event) => {
              if (event.data && event.data.command === 'CACHE_NAME_RESPONSE') {
                console.log(`‚úÖ Active Service Worker Cache Name: ${event.data.cacheName}`);
              }
            };
            existingRegistration.active.postMessage({ command: 'GET_CACHE_NAME' }, [messageChannel.port2]);
          } else if (appConfig.source.offlineCache) {
            // Register if not already registered and offline cache is enabled
            navigator.serviceWorker.register('./service-worker.js', { type: 'module' })
              .then(registration => {
                console.log(`‚úÖ Service Worker registered:`, registration);
              })
              .catch(error => console.error('‚ùå Service Worker registration failed:', error));
          }
        });
      } else {
        console.warn('Service Worker not supported in this browser.');
      }
    })
    .catch(error => {
      // This is a critical error. The app cannot start.
      console.error("‚ùå CRITICAL: Failed to load essential app components. App cannot start.", error);
      document.body.innerHTML = `<div style="padding: 40px 20px; text-align: center; font-family: sans-serif; color: #333;"><h1 style="color: #d9534f;">Application Error</h1><p>The application could not be started due to a critical error.</p><p>Please try refreshing the page. If the problem persists, check the browser console for details.</p></div>`;
    });
</script>
</body>
</html>
