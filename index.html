<!DOCTYPE html>
<html lang="hi"> 
<head>
  <!-- Set theme color for browser UI -->
  <meta charset="UTF-8"/>
  <!-- Dynamic Base URL for GitHub Pages (Adaptive) -->
  <base href="./"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mStore - Online Marketplace</title>
  <link rel="icon" href="./source/assets/logos/app-logo.png" type="image/jpeg">
  <link rel="manifest" href="./manifest.json">
  <link rel="stylesheet" href="./source/common/styles/theme.css" />
    <link rel="stylesheet" href="./source/main.css" />
  <!-- Set theme color for browser UI -->
  <meta name="theme-color" id="theme-color-meta" content="#121212">
  <script>
    // This inline script runs before rendering to prevent a "flash of unstyled content" (FOUC).
    // It sets the theme class on the <html> element and updates the theme-color meta tag.
    (async function() {
      let appConfig = {};
      try {
        const response = await fetch('./source/config.json');
        if (response.ok) {
          appConfig = await response.json();
        }
      } catch (error) {
        console.error("Error loading config.json in inline script:", error);
      }

      const configTheme = appConfig.ui?.theme;
      const preference = localStorage.getItem('app-theme');
      const systemIsDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

      // Priority: config.json -> localStorage -> system preference -> default 'light'
      const theme = configTheme || preference || (systemIsDark ? 'dark' : 'light');

      document.documentElement.classList.add(`${theme}-mode`);
      document.documentElement.dataset.theme = theme;

      // Define theme colors to avoid waiting for CSS. These must match --bg-primary in main.css.
      const themeColors = {
        light: '#f9f9f9',
        dark: '#121212'
      };

      // Update the meta tag immediately to ensure the status bar color is correct on initial load.
      const themeColorMeta = document.getElementById('theme-color-meta');
      if (themeColorMeta) {
        themeColorMeta.setAttribute('content', themeColors[theme]);
      }
    })();
</script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
 </head>
 <body id="main-body">
  <div class="splash-screen" id="splashScreen">
    <div class="splash-content">
      <img src="./source/assets/logos/app-logo.png" 
           class="splash-logo" 
           alt="mStore Logo"
           onerror="this.src='./source/assets/logos/app-logo.png'">
      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>
  </div>
 
 <!-- Page Loader -->
 <div class="page-view-loader hidden">
  <div class="spinner"></div>
</div>

<!-- Header Partial -->
<header id="main-header-placeholder"></header>

<!-- Drawer Partial -->
<aside id="drawer-placeholder"></aside>  

<div id="pullToRefresh">
    <!-- Arrow icon -->
    <span class="material-icons" id="arrowIcon">refresh</span>
    <!-- Spinner icon (hidden by default) -->
    <span class="material-icons" id="spinnerIcon" style="display:none;">autorenew</span>
  </div>


<!-- Page Main Content -->
<main id="page-view-area"></main>
<!-- Dev Mode Switcher (should be last) -->
<div id="role-switcher-placeholder"></div>

<!-- Bottom Navigation Partial (should be last for stacking context) -->
<nav id="bottom-nav-placeholder"></nav>

  <!-- 8. Scripts -->
  <!-- This single module is the main entry point for the application's logic. -->
  <!-- It handles loading all other necessary components and scripts in the correct order. -->
<script>
    const progressBar = document.getElementById('progressBar');
    const splashScreen = document.getElementById('splashScreen');
    // Progress bar animation will be controlled by main.js
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module">
  // ✅ Import critical modules at the top.
  import { getAppConfig } from './source/utils/config-manager.js';
  import { initializePwaInstall, setDeferredPrompt, getDeferredPrompt } from './source/utils/pwa-manager.js';
  // Import the main app initializer, but don't run it yet.
  import { initializeApp } from './source/main.js';

    // --- PWA Install Prompt Handling ---
    // This listener captures the event that allows the app to be installed.
    // It prevents the default browser prompt and saves the event for later use.
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      // Stash the event so it can be triggered later.
      setDeferredPrompt(e);
      // Dispatch a custom event to notify UI components that the app is installable.
      // This is better than directly manipulating the DOM from here.
      window.dispatchEvent(new CustomEvent('pwaInstallReady'));
      console.log('`beforeinstallprompt` event was fired and captured.');
    });

  // 2. Initialize the main application.
  initializeApp()
    .then(() => {
      console.log("✅ Application initialized successfully.");
      // --- Service Worker Management ---
      if ('serviceWorker' in navigator) {
        const appConfig = getAppConfig();
        const swName = appConfig.app.name;
        const swVersion = appConfig.app.version;

        // Log the currently active service worker's version if it exists
        if (navigator.serviceWorker.controller) {
                    console.log(`ℹ️ Active Service Worker Script URL: ${navigator.serviceWorker.controller.scriptURL}`);
        }

        const register = () => {
          if (appConfig.app.environment === 'development') {
          }
          // Register the service worker as a module to allow 'import' statements inside it.
          navigator.serviceWorker.register('./service-worker.js', { type: 'module' })
            .then(registration => {
              console.log(`✅ Service Worker registered successfully:`, registration);
              if (registration.active) {
                console.log(`ℹ️ Registered Service Worker Script URL: ${registration.active.scriptURL}`);

                // Request actual cache name from newly registered service worker
                const messageChannel = new MessageChannel();
                messageChannel.port1.onmessage = (event) => {
                    if (event.data && event.data.command === 'CACHE_NAME_RESPONSE') {
                        console.log(`✅ Registered Service Worker Cache Name: ${event.data.cacheName}`);
                    }
                };
                registration.active.postMessage({ command: 'GET_CACHE_NAME' }, [messageChannel.port2]);
              }
            })
            .catch(error => console.error('❌ Service Worker registration failed:', error, 'Ensure the service worker file is served with the correct MIME type (application/javascript or text/javascript) and not text/html.'));
        };

        const unregister = () => {
          console.log('DEV MODE: Unregistering all service workers.');
          navigator.serviceWorker.getRegistrations().then(registrations => {
            for (let registration of registrations) {
              registration.unregister();
            }
          });
        };

        appConfig.source.offlineCache ? register() : unregister();
      } else {
        console.warn('Service Worker not supported in this browser.');
      }
    })
    .catch(error => {
      // This is a critical error. The app cannot start.
      console.error("❌ CRITICAL: Failed to load essential app components. App cannot start.", error);
      document.body.innerHTML = `<div style="padding: 40px 20px; text-align: center; font-family: sans-serif; color: #333;"><h1 style="color: #d9534f;">Application Error</h1><p>The application could not be started due to a critical error.</p><p>Please try refreshing the page. If the problem persists, check the browser console for details.</p></div>`;
    });
</script>
</body>
</html>
