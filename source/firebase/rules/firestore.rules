rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===================================================================
    // --- HELPER FUNCTIONS ---
    // These functions help maintain clean and readable security rules.
    // ===================================================================

    /**
     * Checks if the requesting user has admin privileges.
     * Note: Currently disabled due to limitations in querying user documents by auth UID.
     * TODO: Implement proper custom claims or user lookup mechanism for production.
     */
    function isAdmin() {
      // Temporarily disabled - requires custom claims implementation
      return false;
    }

    /**
     * Checks if the user owns the specified merchant account.
     * Simplified version that verifies merchant ownership through user profile links.
     */
    function isMerchantOwner(merchantId) {
      return request.auth != null && merchantId != null &&
             exists(/databases/$(database)/documents/merchants/$(merchantId)) &&
             get(/databases/$(database)/documents/merchants/$(merchantId)).data.meta.links.userId ==
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.meta.userId;
    }

    /**
     * Verifies if the requesting user's Firebase Auth UID matches the provided UID.
     */
    function isRequestingUser(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    /**
     * Verifies if the user owns the document they are trying to access.
     * Compares the requester's UID with the UID stored in the document.
     * Primarily used for the users collection.
     */
    function isOwnerOfDoc() {
      return isRequestingUser(resource.data.auth.provider.uid);
    }

    /**
     * Verifies that the user is creating a document for themselves.
     */
    function isCreatingOwnDoc() {
        return isRequestingUser(request.resource.data.auth.provider.uid);
    }


    /**
     * Verifies if the user owns the merchant account identified by merchantId.
     * Retrieves the userId from the merchant document, then compares auth UIDs.
     * Used primarily for item ownership validation.
     */
    function isOwnerOfMerchant(merchantId) {
      let merchantData = get(/databases/$(database)/documents/merchants/$(merchantId)).data;
      let userId = merchantData.meta.links.userId;
      return isRequestingUser(get(/databases/$(database)/documents/users/$(userId)).data.auth.provider.uid);
    }


    // ===================================================================
    // --- PUBLIC COLLECTIONS ---
    // These collections can be read by anyone (including unauthenticated users).
    // Required for displaying initial app data like items and categories.
    // Write permissions are restricted to administrators only.
    // ===================================================================
    match /items/{itemId} {
      allow read: if true;
      // Allow merchants to create items for their own business
      allow create: if isOwnerOfMerchant(request.resource.data.meta.links.merchantId);
      // Temporarily allow any authenticated user to update items (security review needed)
      allow update: if request.auth != null;
      // Delete operations disabled for security - admin privileges required
      allow delete: if false;
    }
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /promotions/{promoId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /brands/{brandId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /units/{unitId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /merchants/{merchantId} {
      allow read: if true; // Merchant profiles are publicly visible
      allow update: if isOwnerOfLinkedDoc(resource.data.meta.links.userId) || isAdmin();
      allow create: if isOwnerOfLinkedDoc(request.resource.data.meta.links.userId) || isAdmin();
      allow delete: if isAdmin();
    }
    match /stories/{merchantId} {
      allow read: if true; // Stories are publicly visible
      allow create: if isOwnerOfLinkedDoc(request.resource.data.meta.links.userId) || isAdmin();
      allow update, delete: if isOwnerOfLinkedDoc(resource.data.meta.links.userId) || isAdmin();
    }

    // Rules for posts collection
    match /posts/{postId} {
      allow read: if true; // Posts are publicly readable
      allow create: if isOwnerOfLinkedDoc(get(/databases/$(database)/documents/merchants/$(request.resource.data.meta.links.merchantId)).data.meta.links.userId) || isAdmin();
      allow update, delete: if isOwnerOfLinkedDoc(get(/databases/$(database)/documents/merchants/$(resource.data.meta.links.merchantId)).data.meta.links.userId) || isAdmin();
    }

    // ===================================================================
    // --- USER-CENTRIC COLLECTIONS ---
    // These collections have rules based on user ownership and permissions.
    // ===================================================================

    match /users/{userId} {
      // GET: Users can read their own profile, admins can read any profile
      // DEV-NOTE: Broad access allowed for development (impersonation feature)
      // PRODUCTION: Restrict to isOwnerOfDoc() only
      allow get: if isOwnerOfDoc() || isAdmin() || request.auth != null;

      // LIST: Authenticated users can query users collection (e.g., for phone validation)
      // WARNING: Development setting - restrict to admins only in production
      allow list: if request.auth != null || isAdmin();

      // UPDATE: Users can update their own profile, admins can update any
      allow update: if isOwnerOfDoc() || isAdmin();
      // CREATE: New users can create their own profile
      allow create: if isCreatingOwnDoc() || isAdmin();
      // DELETE: Only administrators can delete user profiles
      allow delete: if isAdmin();
    }

    match /accounts/{accountId} {
      // GET/UPDATE: Users can access their own account, admins can access any
      allow get, update: if isOwnerOfLinkedDoc(resource.data.meta.links.userId) || isAdmin();
      // LIST: Only administrators can list all accounts
      allow list: if isAdmin();
      // CREATE: User must be authenticated to create an account
      allow create: if request.auth != null;
      allow delete: if isAdmin();
    }

    match /orders/{orderId} {
      // GET/UPDATE: Users can access their own orders, admins can access any
      allow get, update: if isOwnerOfLinkedDoc(resource.data.meta.links.userId) || isAdmin();
      // LIST: Only administrators can list all orders
      allow list: if isAdmin();
      allow create: if isOwnerOfLinkedDoc(request.resource.data.meta.links.userId) || isAdmin();
      allow delete: if isAdmin();
    }

    match /alerts/{alertId} {
      // GET/UPDATE: Users can access their own alerts, admins can access any
      allow get, update: if isOwnerOfLinkedDoc(resource.data.meta.links.userId) || isAdmin();
      // LIST: Only administrators can list all alerts
      allow list: if isAdmin();
      allow create: if isOwnerOfLinkedDoc(request.resource.data.meta.links.userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ===================================================================
    // --- FEEDBACK & RATING COLLECTIONS ---
    // Anyone (including guests) can write to these collections, but only admins can read them.
    // ===================================================================

    match /feedbacks/{feedbackId} {
      // Any authenticated user or guest can submit feedback
      allow create: if request.auth != null || request.resource.data.meta.flags.guest == true;
      // Only administrators can read, update, or delete feedback
      allow read, update, delete: if isAdmin();
    }

    match /ratings/{ratingId} {
      // Any authenticated user or guest can submit ratings
      allow create: if request.auth != null || request.resource.data.meta.flags.guest == true;
      // Only administrators can read, update, or delete ratings
      allow read, update, delete: if isAdmin();
    }

    // Rules for comments on posts
    match /comments/{commentId} {
      allow read: if true; // Comments are publicly readable
      allow create: if request.auth != null; // Authenticated users can create comments
      allow update, delete: if isOwnerOfLinkedDoc(resource.data.meta.links.userId) || isAdmin(); // Only comment owner or admin can modify/delete
    }


    // ===================================================================
    // --- ADMIN & SYSTEM COLLECTIONS ---
    // These collections are restricted to administrators and system access only.
    // ===================================================================

    match /logs/{logId} {
      // GET: Users can view their own logs, admins can view any logs
      allow get: if isOwnerOfLinkedDoc(resource.data.meta.links.userId) || isAdmin();
      // LIST: Only administrators can list all logs (for admin dashboard)
      allow list: if isAdmin();
      // CREATE: User must be authenticated to create logs
      allow create: if request.auth != null;
      allow delete: if isAdmin();
    }

    // Counters collection used for atomic ID generation
    match /counters/{counterId} {
      allow read, write: if request.auth != null || isAdmin();
    }

    match /price-logs/{priceLogId} {
        allow read, write: if isAdmin();
    }

    // Campaigns collection for mass-messaging, managed by administrators only
    match /campaigns/{campaignId} {
      allow read, write: if isAdmin();
    }
  }
}

// Deploy command:
// firebase deploy --only firestore:rules